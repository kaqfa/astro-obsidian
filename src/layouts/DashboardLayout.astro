---
import MainLayout from "./MainLayout.astro";
import FileTree from "../components/FileTree.astro";
import SearchBar from "../components/SearchBar";
import ThemeToggle from "../components/ThemeToggle";
import ReadingModeToggle from "../components/ReadingModeToggle";
import Breadcrumb from "../components/Breadcrumb.astro";
import { getFileTree, getAllNotes } from "../lib/vault";
import { getLastSync } from "../lib/git";

interface Props {
  title: string;
  currentPath?: string;
}

const { title, currentPath = "" } = Astro.props;

const tree = await getFileTree();
const allNotes = await getAllNotes();
const lastSync = await getLastSync();
---

<MainLayout title={title}>
  <div class="h-screen flex overflow-hidden bg-bg-primary">
    <!-- Sidebar -->
    <aside
      data-sidebar
      class="w-80 bg-bg-secondary border-r border-border flex flex-col shrink-0 transition-all duration-300"
      transition:persist
    >
      <!-- Header -->
      <div class="p-4 border-b border-border space-y-4">
        <!-- Vault Title with modern icon -->
        <div class="flex items-center gap-3">
          <div class="p-2 bg-accent/10 rounded-lg">
            <svg
              class="w-5 h-5 text-accent"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
              ></path>
            </svg>
          </div>
          <div class="flex-1">
            <h1 class="text-base font-bold text-text-primary">My Vault</h1>
            <p class="text-xs text-text-muted">
              {
                lastSync
                  ? `Synced ${new Date(lastSync).toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" })}`
                  : "Not synced"
              }
            </p>
          </div>
        </div>

        <!-- Modern Sync Button -->
        <button
          id="sync-btn"
          class="w-full px-4 py-2.5 bg-accent hover:bg-accent-hover text-white rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow-md group"
        >
          <svg
            class="w-4 h-4 sync-icon transition-transform group-hover:rotate-180 duration-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            ></path>
          </svg>
          <span class="sync-text">Sync Now</span>
        </button>
      </div>

      <!-- File Tree -->
      <div class="flex-1 overflow-y-auto scrollbar-thin p-2 min-w-0">
        <div class="overflow-x-auto min-w-0">
          <FileTree tree={tree} />
        </div>
      </div>

      <!-- Logout -->
      <div class="p-3 border-t border-border">
        <form action="/api/logout" method="POST">
          <button
            type="submit"
            class="w-full px-4 py-2 bg-bg-tertiary hover:bg-error/10 text-text-muted hover:text-error rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 group border border-transparent hover:border-error/20"
          >
            <svg
              class="w-4 h-4 transition-transform group-hover:translate-x-0.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
              ></path>
            </svg>
            <span>Logout</span>
          </button>
        </form>
      </div>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="flex-1 flex flex-col min-w-0">
      <!-- Top Bar / Header -->
      <header
        class="h-16 border-b border-border bg-bg-primary/80 backdrop-blur flex items-center justify-between px-6 shrink-0 z-10 sticky top-0"
      >
        <div class="flex items-center gap-4 min-w-0">
          <!-- Breadcrumb Navigation -->
          {
            currentPath ? (
              <Breadcrumb slug={currentPath} />
            ) : (
              <div class="flex items-center gap-2">
                <svg
                  class="w-5 h-5 text-accent"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
                  />
                </svg>
                <h2 class="text-lg font-medium text-text-primary">Dashboard</h2>
              </div>
            )
          }
        </div>

        <div class="flex items-center gap-3">
          <div class="w-72">
            <SearchBar client:load notes={allNotes} />
          </div>
          <ReadingModeToggle client:load />
          <ThemeToggle client:load />
        </div>
      </header>

      <!-- Content Area -->
      <main class="flex-1 overflow-y-auto scrollbar-thin p-8">
        <slot />
      </main>
    </div>
  </div>

  <script>
    document.addEventListener("astro:page-load", () => {
      // Sync Button Handler
      document
        .getElementById("sync-btn")
        ?.addEventListener("click", async (e) => {
          const btn = e.currentTarget as HTMLButtonElement;
          const icon = btn.querySelector(".sync-icon") as HTMLSpanElement;
          const text = btn.querySelector(".sync-text") as HTMLSpanElement;

          btn.disabled = true;
          icon.textContent = "â³";
          text.textContent = "Syncing...";
          icon.classList.add("animate-spin");

          try {
            const res = await fetch("/api/sync", { method: "POST" });
            const data = await res.json();

            if (data.success) {
              icon.textContent = "âœ…";
              text.textContent = "Synced!";
              icon.classList.remove("animate-spin");
              setTimeout(() => window.location.reload(), 1000);
            } else {
              icon.textContent = "âŒ";
              text.textContent = "Error";
              icon.classList.remove("animate-spin");
              setTimeout(() => {
                btn.disabled = false;
                icon.textContent = "ðŸ”„";
                text.textContent = "Sync";
              }, 2000);
            }
          } catch {
            icon.textContent = "âŒ";
            text.textContent = "Error";
            icon.classList.remove("animate-spin");
            setTimeout(() => {
              btn.disabled = false;
              icon.textContent = "ðŸ”„";
              text.textContent = "Sync";
            }, 2000);
          }
        });

      // Handle Excalidraw embeds globally for all pages using this layout
      const embeds = document.querySelectorAll(".excalidraw-embed");
      embeds.forEach(async (embed) => {
        const data = embed.getAttribute("data-excalidraw");
        if (data && !embed.hasChildNodes()) {
          const decoded = decodeURIComponent(data);
          embed.innerHTML = `<iframe 
            src="https://excalidraw.com/#json=${btoa(decoded)}" 
            width="100%" 
            height="500"
            frameborder="0"
            class="rounded-lg border border-border"
          ></iframe>`;
        }
      });

      // Handle copy code buttons
      const copyButtons = document.querySelectorAll(".copy-code-btn");
      copyButtons.forEach((button) => {
        button.addEventListener("click", async () => {
          const codeText = button.getAttribute("data-code");
          if (!codeText) return;

          try {
            await navigator.clipboard.writeText(codeText);

            // Success feedback
            const icon = button.querySelector(".copy-icon");
            const originalIcon = icon?.textContent;

            button.classList.add("copied");
            if (icon) icon.textContent = "âœ“";

            setTimeout(() => {
              button.classList.remove("copied");
              if (icon && originalIcon) icon.textContent = originalIcon;
            }, 2000);
          } catch (err) {
            console.error("Failed to copy code:", err);
            // Fallback for older browsers
            const textarea = document.createElement("textarea");
            textarea.value = codeText;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand("copy");
            document.body.removeChild(textarea);
          }
        });
      });
    });
    /* Loading Indicator Logic */
    const overlay = document.getElementById("loading-overlay");

    document.addEventListener("astro:before-preparation", () => {
      if (overlay) {
        overlay.classList.remove("opacity-0", "pointer-events-none");
      }
    });

    document.addEventListener("astro:after-swap", () => {
      if (overlay) {
        overlay.classList.add("opacity-0", "pointer-events-none");
      }
    });
  </script>

  <div
    id="loading-overlay"
    class="fixed inset-0 bg-bg-primary/50 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200"
  >
    <div class="flex flex-col items-center gap-3">
      <div
        class="w-10 h-10 border-4 border-accent border-t-transparent rounded-full animate-spin"
      >
      </div>
      <span class="text-text-primary font-medium animate-pulse">Loading...</span
      >
    </div>
  </div>
</MainLayout>
