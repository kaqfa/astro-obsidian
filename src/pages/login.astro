---
import MainLayout from "../layouts/MainLayout.astro";
import { lucia } from "../lib/auth";
import { db } from "../lib/db";
import { userTable } from "../lib/db/schema";
import { validateSession } from "../lib/middleware";
import * as bcrypt from "bcrypt";
import { eq } from "drizzle-orm";

// IMPORTANT: Disable caching for login page
Astro.response.headers.set('Cache-Control', 'no-store, no-cache, must-revalidate, private');
Astro.response.headers.set('Pragma', 'no-cache');
Astro.response.headers.set('Expires', '0');

// Debug: Check database connection and users at page load
try {
  console.log('[LOGIN-PAGE] Checking database state...');
  const testConnection = await db.select().from(userTable);
  console.log(`[LOGIN-PAGE] Database connection OK. Found ${testConnection.length} users.`);
} catch (err) {
  console.error('[LOGIN-PAGE] Database connection error:', err);
}

const { user } = await validateSession(Astro.cookies);

console.log(`[LOGIN-PAGE] User validation result:`, { user: user ? { id: user.id, username: user.username } : null });

if (user) {
  console.log('[LOGIN-PAGE] User already logged in, redirecting to /');
  return Astro.redirect("/");
}

let error = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const username = formData.get("username")?.toString() ?? "";
  const password = formData.get("password")?.toString() ?? "";

  if (!username || !password) {
    error = "Username dan password harus diisi";
  } else {
    try {
      // Add debug logging
      console.log(`[LOGIN] Attempting login for username: ${username}`);
      
      const users = await db
        .select()
        .from(userTable)
        .where(eq(userTable.username, username));

      console.log(`[LOGIN] Found ${users.length} users with username: ${username}`);
      
      const foundUser = users[0];
      
      if (!foundUser) {
        console.log(`[LOGIN] User not found: ${username}`);
        error = "Username atau password salah";
      } else {
        console.log(`[LOGIN] User found, comparing passwords...`);
        const isValidPassword = await bcrypt.compare(password, foundUser.passwordHash);
        console.log(`[LOGIN] Password validation result: ${isValidPassword}`);
        
        if (!isValidPassword) {
          error = "Username atau password salah";
        } else {
          console.log(`[LOGIN] Creating session for user: ${foundUser.id}`);
          const session = await lucia.createSession(foundUser.id, {});
          const sessionCookie = lucia.createSessionCookie(session.id);

          console.log(`[LOGIN] Cookie details:`, {
            name: sessionCookie.name,
            valueLength: sessionCookie.value?.length || 0,
            attributes: sessionCookie.attributes
          });

          Astro.cookies.set(
            sessionCookie.name,
            sessionCookie.value,
            sessionCookie.attributes
          );

          console.log(`[LOGIN] Cookie set via Astro.cookies.set()`);
          console.log(`[LOGIN] Current cookies after set:`, {
            hasSession: !!Astro.cookies.get(sessionCookie.name),
            sessionValue: Astro.cookies.get(sessionCookie.name)?.value?.substring(0, 10) + '...'
          });

          console.log(`[LOGIN] Session created successfully, redirecting...`);
          return Astro.redirect("/");
        }
      }
    } catch (err) {
      console.error(`[LOGIN] Error during login:`, err);
      error = "Terjadi kesalahan saat login";
    }
  }
}
---

<MainLayout title="Login - Obsidian Web">
  <div class="min-h-screen flex">
    <!-- Left Side - Decorative -->
    <div
      class="hidden lg:flex lg:w-1/2 relative overflow-hidden bg-gradient-to-br from-[#1a1f2e] via-[#2d3748] to-[#1e1e1e]"
    >
      <!-- Animated Gradient Background -->
      <div
        class="absolute inset-0 bg-gradient-to-br from-accent/20 via-transparent to-accent/10"
      >
      </div>

      <!-- Grid Pattern Overlay -->
      <div
        class="absolute inset-0 opacity-5"
        style="background-image: linear-gradient(rgba(255,255,255,.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,.1) 1px, transparent 1px); background-size: 50px 50px;"
      >
      </div>

      <!-- Content -->
      <div
        class="relative z-10 flex flex-col justify-center items-center w-full p-12 text-white"
      >
        <!-- SVG Logo Icon -->
        <div class="mb-8 w-40 h-40 relative">
          <!-- Glowing background circle -->
          <div
            class="absolute inset-0 bg-gradient-to-br from-accent/30 to-accent/10 rounded-full blur-2xl"
          >
          </div>

          <!-- Main Icon -->
          <div class="relative w-full h-full flex items-center justify-center">
            <div
              class="w-32 h-32 rounded-2xl bg-gradient-to-br from-accent/20 to-accent/5 backdrop-blur-sm border border-accent/30 flex items-center justify-center shadow-2xl"
            >
              <svg
                class="w-20 h-20 text-accent"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
                ></path>
              </svg>
            </div>
          </div>

          <!-- Orbiting dots -->
          <div
            class="absolute top-0 right-0 w-3 h-3 bg-accent rounded-full animate-pulse"
          >
          </div>
          <div
            class="absolute bottom-0 left-0 w-2 h-2 bg-accent/60 rounded-full animate-pulse delay-150"
          >
          </div>
        </div>

        <!-- Welcome Text -->
        <h1
          class="text-4xl font-bold mb-4 text-center bg-gradient-to-r from-[#67b3e7] to-[#4c9fd9] bg-clip-text text-transparent"
        >
          Obsidian Web Viewer
        </h1>
        <p class="text-xl text-gray-300 text-center max-w-md leading-relaxed">
          Access your knowledge vault from anywhere. Beautiful, fast, and
          secure.
        </p>

        <!-- Features -->
        <div class="mt-12 space-y-4 w-full max-w-md">
          <div class="flex items-center gap-3 text-gray-200">
            <div
              class="w-10 h-10 rounded-lg bg-accent/20 flex items-center justify-center flex-shrink-0"
            >
              <svg
                class="w-5 h-5 text-accent"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                ></path>
              </svg>
            </div>
            <div>
              <h3 class="font-semibold">Secure Access</h3>
              <p class="text-sm text-gray-400">
                Your data is protected with encryption
              </p>
            </div>
          </div>

          <div class="flex items-center gap-3 text-gray-200">
            <div
              class="w-10 h-10 rounded-lg bg-accent/20 flex items-center justify-center flex-shrink-0"
            >
              <svg
                class="w-5 h-5 text-accent"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
            </div>
            <div>
              <h3 class="font-semibold">Lightning Fast</h3>
              <p class="text-sm text-gray-400">
                Optimized for speed and performance
              </p>
            </div>
          </div>

          <div class="flex items-center gap-3 text-gray-200">
            <div
              class="w-10 h-10 rounded-lg bg-accent/20 flex items-center justify-center flex-shrink-0"
            >
              <svg
                class="w-5 h-5 text-accent"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"
                ></path>
              </svg>
            </div>
            <div>
              <h3 class="font-semibold">Beautiful Design</h3>
              <p class="text-sm text-gray-400">Clean and modern interface</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Decorative Elements -->
      <div
        class="absolute top-0 right-0 w-96 h-96 bg-accent/5 rounded-full blur-3xl"
      >
      </div>
      <div
        class="absolute bottom-0 left-0 w-96 h-96 bg-accent/5 rounded-full blur-3xl"
      >
      </div>
    </div>

    <!-- Right Side - Login Form -->
    <div
      class="w-full lg:w-1/2 flex items-center justify-center p-6 bg-bg-primary"
    >
      <div class="w-full max-w-md">
        <!-- Mobile Logo -->
        <div class="lg:hidden text-center mb-8">
          <div
            class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-accent/10 mb-4"
          >
            <svg
              class="w-8 h-8 text-accent"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
              ></path>
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-text-primary">Obsidian Web</h1>
          <p class="text-text-muted mt-2">Sign in to your account</p>
        </div>

        <!-- Header -->
        <div class="mb-8 hidden lg:block">
          <h2 class="text-3xl font-bold text-text-primary mb-2">
            Welcome back!
          </h2>
          <p class="text-text-muted">
            Enter your credentials to access your vault
          </p>
        </div>

        <!-- Error Alert -->
        {
          error && (
            <div class="mb-6 p-4 bg-error/10 border-l-4 border-error rounded-r-lg flex items-start gap-3">
              <svg
                class="w-5 h-5 text-error flex-shrink-0 mt-0.5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <div>
                <h4 class="font-semibold text-error mb-1">
                  Authentication Failed
                </h4>
                <p class="text-sm text-error/80">{error}</p>
              </div>
            </div>
          )
        }

        <!-- Login Form -->
        <form method="POST" class="space-y-5">
          <!-- Username -->
          <div>
            <label
              for="username"
              class="block text-sm font-semibold text-text-secondary mb-2"
            >
              Username
            </label>
            <div class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <svg
                  class="w-5 h-5 text-text-muted"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                  ></path>
                </svg>
              </div>
              <input
                type="text"
                id="username"
                name="username"
                required
                autocomplete="username"
                class="w-full pl-10 pr-4 py-3 bg-bg-secondary border border-border rounded-lg text-text-primary placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent transition-all"
                placeholder="Enter your username"
              />
            </div>
          </div>

          <!-- Password -->
          <div>
            <label
              for="password"
              class="block text-sm font-semibold text-text-secondary mb-2"
            >
              Password
            </label>
            <div class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <svg
                  class="w-5 h-5 text-text-muted"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                  ></path>
                </svg>
              </div>
              <input
                type="password"
                id="password"
                name="password"
                required
                autocomplete="current-password"
                class="w-full pl-10 pr-4 py-3 bg-bg-secondary border border-border rounded-lg text-text-primary placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent transition-all"
                placeholder="Enter your password"
              />
            </div>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            class="w-full py-3.5 px-4 bg-accent hover:bg-accent-hover text-white font-semibold rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-bg-primary shadow-lg hover:shadow-xl flex items-center justify-center gap-2 group"
          >
            <span>Sign in to your vault</span>
            <svg
              class="w-5 h-5 group-hover:translate-x-1 transition-transform"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
            </svg>
          </button>
        </form>

        <!-- Footer -->
        <div class="mt-8 text-center">
          <p class="text-text-muted text-sm">
            Obsidian Web Viewer v2.1 â€¢ Read-only vault access
          </p>
        </div>
      </div>
    </div>
  </div>
</MainLayout>
