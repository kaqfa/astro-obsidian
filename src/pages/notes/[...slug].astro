---
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import { validateSession } from "../../lib/middleware";
import { getNote } from "../../lib/vault";
import { processMarkdown, extractHeadings } from "../../lib/markdown";

const { user } = await validateSession(Astro.cookies);

if (!user) {
  return Astro.redirect("/login");
}

const slug = Astro.params.slug || "";
const note = await getNote(slug);

if (!note) {
  return new Response("Note not found", { status: 404 });
}

const html = await processMarkdown(note.content);
const headings = extractHeadings(note.content);

// Extract breadcrumb from slug
const breadcrumbs = slug.split("/").filter(Boolean);
const currentPath = slug;
---

<DashboardLayout title={note.title} currentPath={currentPath}>
  <div class="max-w-6xl mx-auto flex gap-8">
    <!-- Main Article -->
    <div class="flex-1 min-w-0">
      <!-- Title Section -->
      <div class="mb-8 pb-6 border-b border-border">
        <h1
          class="text-3xl md:text-4xl font-bold text-text-primary mb-3 leading-tight"
        >
          {note.title}
        </h1>
        <div class="flex items-center gap-4 text-sm text-text-muted">
          <span class="flex items-center gap-1.5">
            <span>üìÖ</span>
            {
              note.lastModified.toLocaleDateString("id-ID", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })
            }
          </span>
          <span class="flex items-center gap-1.5">
            <span>üïê</span>
            {
              note.lastModified.toLocaleTimeString("id-ID", {
                hour: "2-digit",
                minute: "2-digit",
              })
            }
          </span>
        </div>
      </div>

      <!-- Content -->
      <article class="prose prose-invert max-w-none" set:html={html} />
    </div>

    <!-- Table of Contents (Right Sidebar) -->
    {
      headings.length > 0 && (
        <aside class="w-64 hidden xl:block shrink-0">
          <div class="sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto">
            <h3 class="text-sm font-semibold text-text-primary mb-3 uppercase tracking-wider">
              On this page
            </h3>
            <nav class="flex flex-col gap-1">
              {headings.map((heading) => (
                <a
                  href={`#${heading.slug}`}
                  class={`text-sm text-text-muted hover:text-accent transition-colors block py-0.5
                  ${heading.depth === 1 ? "font-medium" : ""}
                  ${heading.depth === 2 ? "pl-2" : ""}
                  ${heading.depth === 3 ? "pl-4" : ""}
                  ${heading.depth > 3 ? "pl-6" : ""}
                `}
                >
                  {heading.text}
                </a>
              ))}
            </nav>
          </div>
        </aside>
      )
    }
  </div>

  <!-- Mermaid Script -->
  <script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs";

    // Initialize once
    mermaid.initialize({
      startOnLoad: false,
      theme: "dark",
    });

    // Run on every page load (initial + navigation)
    document.addEventListener("astro:page-load", async () => {
      const graphs = document.querySelectorAll(".mermaid");
      if (graphs.length > 0) {
        await mermaid.run({
          nodes: graphs,
        });
      }
    });
  </script>
</DashboardLayout>
