---
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import PublicLayout from "../../layouts/PublicLayout.astro";
import { validateSession } from "../../lib/middleware";
import { getNote } from "../../lib/vault";
import { processMarkdown, extractHeadings } from "../../lib/markdown";
import { isNotePublic } from "../../lib/public-notes";

const slug = Astro.params.slug || "";
const note = await getNote(slug);

if (!note) {
  return new Response("Note not found", { status: 404 });
}

// Check if user is logged in OR note is public
const { user } = await validateSession(Astro.cookies);
const isPublic = await isNotePublic(slug);

if (!user && !isPublic) {
  return Astro.redirect("/login");
}

// Cache is warmed at server level, no need to build here
const html = await processMarkdown(note.content, slug);
const headings = extractHeadings(note.content);

// Add cache headers for better performance
Astro.response.headers.set('Cache-Control', isPublic ? 'public, max-age=300' : 'private, max-age=300, stale-while-revalidate=600');

// Extract breadcrumb from slug
const breadcrumbs = slug.split("/").filter(Boolean);
const currentPath = slug;

// Use PublicLayout if note is public and user not logged in
const Layout = (!user && isPublic) ? PublicLayout : DashboardLayout;
---

<Layout title={note.title} currentPath={currentPath} isPublic={isPublic}>
  <div class="max-w-6xl mx-auto flex gap-8">
    <!-- Main Article -->
    <div class="flex-1 min-w-0">
      <!-- Title Section -->
      <div class="mb-8 pb-6 border-b border-border">
        <h1
          class="text-3xl md:text-4xl font-bold text-text-primary mb-3 leading-tight"
        >
          {note.title}
        </h1>
        <div class="flex items-center gap-4 text-sm text-text-muted">
          <span class="flex items-center gap-1.5">
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
              ></path>
            </svg>
            {
              note.lastModified.toLocaleDateString("id-ID", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })
            }
          </span>
          <span class="flex items-center gap-1.5">
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            {
              note.lastModified.toLocaleTimeString("id-ID", {
                hour: "2-digit",
                minute: "2-digit",
              })
            }
          </span>
        </div>
      </div>

      <!-- Content -->
      <article class="prose prose-invert max-w-none" set:html={html} />
    </div>

    <!-- Table of Contents (Right Sidebar) -->
    {
      headings.length > 0 && (
        <aside class="w-64 hidden xl:block shrink-0">
          <div class="sticky top-4 max-h-[calc(100vh-2rem)]">
            <div class="bg-bg-secondary/50 border border-border rounded-lg p-4 overflow-y-auto max-h-[calc(100vh-3rem)]">
              <h3 class="text-xs font-bold text-text-primary mb-3 uppercase tracking-wider flex items-center gap-2">
                <svg
                  class="w-4 h-4 text-accent"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 12h16M4 18h7"
                  />
                </svg>
                On this page
              </h3>
              <nav class="flex flex-col gap-1.5">
                {headings.map((heading) => (
                  <a
                    href={`#${heading.slug}`}
                    class={`text-sm text-text-muted hover:text-accent block py-1 hover:pl-2 transition-all duration-200 border-l-2 border-transparent hover:border-accent
                    ${heading.depth === 1 ? "font-medium" : ""}
                    ${heading.depth === 2 ? "pl-2" : ""}
                    ${heading.depth === 3 ? "pl-4" : ""}
                    ${heading.depth > 3 ? "pl-6" : ""}
                  `}
                  >
                    {heading.text}
                  </a>
                ))}
              </nav>
            </div>
          </div>
        </aside>
      )
    }
  </div>

  <!-- Mermaid Script -->
  <script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs";

    // Initialize once
    mermaid.initialize({
      startOnLoad: false,
      theme: "dark",
    });

    // Run on every page load (initial + navigation)
    document.addEventListener("astro:page-load", async () => {
      const graphs = document.querySelectorAll(".mermaid");
      if (graphs.length > 0) {
        await mermaid.run({
          nodes: graphs,
        });
      }
    });
  </script>

  <!-- Track recent note view -->
  <script is:inline define:vars={{ note }}>
    (function() {
      const STORAGE_KEY = 'obsidian-recent-notes';
      const MAX_RECENT_NOTES = 10;

      function getRecentNotes() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          return stored ? JSON.parse(stored) : [];
        } catch {
          return [];
        }
      }

      function addRecentNote(note) {
        try {
          const recent = getRecentNotes();
          const now = Date.now();

          // Remove existing entry with same slug
          const filtered = recent.filter(r => r.slug !== note.slug);

          // Add new entry
          const entry = {
            slug: note.slug,
            title: note.title,
            path: note.path,
            viewedAt: now
          };

          const updated = [entry, ...filtered].slice(0, MAX_RECENT_NOTES);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
        } catch (e) {
          console.error('[RecentNotes] Failed to save:', e);
        }
      }

      // Track this note view
      addRecentNote({
        slug: { note.slug },
        title: { note.title },
        path: { note.path }
      });
    })();
  </script>
</DashboardLayout>
